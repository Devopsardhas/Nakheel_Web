@using Microsoft.AspNetCore.Http;
@using Nakheel_Web.Models.AccountsMaster;
@using Newtonsoft.Json;
@using static Nakheel_Web.Authentication.Common;
@inject IHttpContextAccessor HttpContextAccessor;
@{
    var str = HttpContextAccessor.HttpContext!.Session.GetString("Login");
    string Des = Decrypt(str!);
    Login_ LoginClass = JsonConvert.DeserializeObject<Login_>(Des!)!;
}
@{
    Layout = null;
}
<style>
    .form-label, .form-control {
        margin-bottom: 0.5rem;
        color: #141b2b;
        font-weight: 500;
        font-family: 'Nakheel-Textregular';
        font-size: 15px;
    }

    label {
        color: #141b2b;
        font-weight: 500;
        font-family: 'Nakheel-Textregular' !important;
        font-size: 15px;
    }

    table {
        font-family: 'Nakheel-Textregular';
    }

    span {
        font-weight: 500;
        font-family: 'Nakheel-Textregular';
        font-size: 15px;
    }

    .Cls_History_Approval {
        background: #00263a;
        color: white;
        height: 30px;
        width: 100%;
    }
</style>
<style>
    .accordion-button {
        background-color: #00263a !important;
        color: white;
    }
        .accordion-button:not() {
            background-color: #00263a !important;
            color: white;
        }
    .accordion-body {
        padding: 0rem 0.25rem !important;
    }
    .accordion-button:not(.collapsed) {
        color: white !important;
    }
</style>
@model Nakheel_Web.Models.HandOverInsMaster.M_Insp_HealthSafety_Model;
@if (Model != null)
{
    <form id="F_HealthSafety_View" action="#" method="post" class="row NotValid" novalidate="novalidate">
        <div class="row">
            <div class="col-12">
                <div class="row">
                    <!-- HandOver Building Detail -->
                    <div class="col-xxl-12 mb-5 mb-xxl-0">
                        @if (Model != null)
                        {
                            <br />
                            <input type="hidden" value="@Model.Insp_HealthSafety_Id" id="Insp_HealthSafety_EId">
                            <input type="hidden" value="@Model.Unique_Id" id="EUnique_Id">
                            <input type="hidden" value="@Model.Health_Safety_Type" id="View_Health_Safety_Type">
                            <input type="hidden" value="@LoginClass.Employee_Identity_Id" id="CreatedBy">
                            <input type="hidden" value="@Model.Business_Unit_Id" id="EBusiness_Unit_Id">
                            <input type="hidden" value="@Model.Zone_Id" id="EZone_Id">
                            <input type="hidden" value="@Model.Community_Id" id="ECommunity_Id">
                            <input type="hidden" value="@Model.Building_Id" id="EBuilding_Id">
                            <input type="hidden" value="@Model.Date_of_Inspection" id="EDate_of_Inspection">
                            <table class="table table-sm tab ">
                                <tbody id="tblHealthSafetyView">
                                    <tr>
                                        <td><b class="font-bold">Reference No</b></td>
                                        <td>:</td>
                                        <td class="tdtxt">NCM-@Model.Unique_Id</td>

                                        <td style="display:none"><b class="font-bold">Company Name</b></td>
                                        <td style="display:none">:</td>
                                        <td class="tdtxt" style="display:none">@Model.Company_Name</td>

                                        <td><b class="font-bold">Inspected By</b></td>
                                        <td>:</td>
                                        <td class="tdtxt">@Model.Inspected_By_Name</td>

                                        <td><b class="font-bold">Date of Inspection</b></td>
                                        <td>:</td>
                                        <td class="tdtxt">@Model.Date_of_Inspection</td>
                                    </tr>
                                    <tr>
                                        <td><b class="font-bold">Business Unit</b></td>
                                        <td>:</td>
                                        <td class="tdtxt">@Model.Business_Unit_Name</td>

                                        <td><b class="font-bold">Zone</b></td>
                                        <td>:</td>
                                        <td class="tdtxt">@Model.Zone_Name</td>

                                        <td><b class="font-bold">Community</b></td>
                                        <td>:</td>
                                        <td class="tdtxt">@Model.Community_Name</td>
                                    </tr>
                                    <tr>
                                        <td><b class="font-bold">Building</b></td>
                                        <td>:</td>
                                        <td class="tdtxt">@Model.Building_Name</td>
                                        @if (Model!.Status != "25" || Model!.Status == "9")
                                        {
                                            @if (LoginClass.Role_Id == "9" || LoginClass.Role_Id == "10" || LoginClass.Role_Id == "11")
                                            {
                                                <td><b class="font-bold">Manager</b></td>
                                                <td>:</td>
                                                <td class="tdtxt">@Model.Zone_Manager</td>

                                                <td><b class="font-bold">Zone Supervisor</b></td>
                                                <td>:</td>
                                                <td class="tdtxt">@Model.Zone_Supervisor</td>
                                            }
                                        }
                                    </tr>
                                    <tr>
                                        @if (Model.Business_Unit_Type_Name != "0" && Model.Business_Unit_Type_Name != null)
                                        {
                                            var obane = "";
                                            <td><b class="font-bold">Business Unit Type</b></td>
                                            <td>:</td>
                                            @if (Model.Business_Unit_Type_Name == "Party")
                                            {
                                                obane = "JOP 3rd Party";
                                            }
                                            else if (Model.Business_Unit_Type_Name == "JOP_Common")
                                            {
                                                obane = "JOP-Common Area";
                                            }
                                            else
                                            {
                                                obane = "Master Community";
                                            }
                                            <td class="tdtxt" style="word-break: break-all">@obane</td>
                                        }

                                        @if (Model!.Status == "25" || Model!.Status == "9" || Model!.Status == "15")
                                        {
                                            @if (LoginClass.Role_Id == "9" || LoginClass.Role_Id == "10" || LoginClass.Role_Id == "11")
                                            {
                                                <td><b class="font-bold">NCM Manager</b><span class="requ">*</span></td>
                                                <td>:</td>
                                                <td>
                                                    <select class="form-select" name="EZone_Manager" id="EZone_Manager" required>
                                                    </select>
                                                </td>
                                                <td><b class="font-bold">NCM Supervisor</b><span class="requ">*</span></td>
                                                <td>:</td>
                                                <td>
                                                    <select class="form-select" name="EZone_Supervisor" id="EZone_Supervisor" required>
                                                    </select>
                                                </td>
                                                <td><b class="font-bold">Date of Inspection</b></td>
                                                <td>:</td>
                                                <td><input class="form-control" type="date" id="Inspection_Date" name="Inspection_Date" /></td>
                                            }
                                        }
                                    </tr>
                                </tbody>
                            </table>
                            <div class="card-body" style="display:none;">
                                <div class="row">
                                    <div class="mb-3">
                                        <label for="example-number-input" class="col-md-4 col-form-label">Description</label>
                                        <div class="col-md-12">
                                            <textarea class="form-control" id="EDescription" name="EDescription"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </form>
    <!-- History of Fire & Life Safety -->
    <div class="card-body">
        <div class="row">
            <div class="col-xl-12">
                <div class="mt-xl-0 mt-4">
                    <div class="accordion" id="accordionExample">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTwo">
                                <button class="accordion-button fw-medium collapsed Cls_History_Approval" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                    History of Approval
                                </button>
                            </h2>
                            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#accordionExample">
                                <div class="accordion-body">
                                    <div class="text-muted">
                                        @if (Model!.L_Insp_HealthSafety_History != null && Model.L_Insp_HealthSafety_History.Count != 0)
                                        {
                                            <br>
                                            <table id="tblFireLifeSafetyHistory" class="table table-sm table-striped dt-responsive nowrap tblround" style="width:100%">
                                                <thead>
                                                    <tr>
                                                        <th>Employee Name</th>
                                                        <th>Role</th>
                                                        <th>Assigned/ Created Date</th>
                                                        <th>Action Taken Date</th>
                                                        <th>Prev.Status</th>
                                                        <th>Cur.Status</th>
                                                        <th>Next Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="GettblHealthInspHistory">
                                                    @foreach (var item in Model.L_Insp_HealthSafety_History)
                                                    {
                                                        <tr class="clstr">
                                                            <td align="left" valign="middle">@item.Emp_Id</td>
                                                            <td align="left" valign="middle">@item.Role_Id</td>
                                                            <td align="left" valign="middle">@item.History_DateTime</td>
                                                            <td align="left" valign="middle">@item.CreatedDate</td>
                                                            <td align="left" valign="middle">@item.Status</td>
                                                            <td align="left" valign="middle">@item.Remarks</td>
                                                            <td align="left" valign="middle">@item.Next_Action</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @*<div id="ViewHealthSafetyList_History">
    </div>*@
    <!-- Acknowledged By HSSE Team -->
    @if (Model!.Status == "25" || Model!.Status == "9" || Model!.Status == "15")
    {
        @if (LoginClass.Role_Id == "9" || LoginClass.Role_Id == "10" || LoginClass.Role_Id == "11")
        {
            <div style="display:none;">
                <form id="F_Health_Safety_Ack" action="#" method="post" class="row NotValid" novalidate="novalidate">
                    <div class="row">
                        <div class="col-lg-6">
                            <button type="button" class="btn btn-success waves-effect waves-light submit_Approval" style="float: right;cursor:pointer">
                                <i class="bx bx-check-double font-size-16 align-middle me-2"></i> Submit
                            </button>
                        </div>
                        <div class="col-lg-6">
                            <button type="reset" class="btn btn-danger waves-effect waves-light" style="cursor:pointer;">
                                <i class="bx bx-block font-size-16 align-middle me-2"></i> Cancel
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        }
    }
    <!-- Checklist Fill By HSSE Team -->
    @if (Model!.Status == "2")
    {
        @if (LoginClass.Role_Id == "9" || LoginClass.Role_Id == "10" || LoginClass.Role_Id == "11")
        {
            <div>
                <form id="F_Health_Safety_Ack_Qns" action="#" method="post" class="row NotValid" novalidate="novalidate">
                    <!-- Questionnaires List Edit -->
                    <div class="row Qns" id="divViewHealthSafetyQns_btn" style=" display:none;">
                        <div class="col-md-12 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <div class="col-lg-9">
                                        <h4 class="d-flex align-items-center mb-3">Health & Safety Inspection Questionnaires</h4>
                                    </div>
                                    <hr />
                                    <div id="GetQuestionnaireList_btn">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-6">
                                        <button type="button" class="btn btn-success waves-effect waves-light submit_Findings" style="float: right;cursor:pointer">
                                            <i class="bx bx-check-double font-size-16 align-middle me-2"></i> Submit
                                        </button>
                                    </div>
                                    <div class="col-lg-6">
                                        <button type="reset" class="btn btn-danger waves-effect waves-light" style="cursor:pointer;">
                                            <i class="bx bx-block font-size-16 align-middle me-2"></i> Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br />
                </form>
            </div>
        }
    }
    <br>
}
<script>
    //debugger;
    $(document).ready(function () {
        var now = new Date();
        var day = ("0" + now.getDate()).slice(-2);
        var month = ("0" + (now.getMonth() + 1)).slice(-2);
        var today = now.getFullYear() + "-" + (month) + "-" + (day);
        $("#Inspection_Date").val(today);
    })
    $(".submit_Approval").click(function () {
        var Obj = {
            Insp_HealthSafety_Id: $("#Insp_HealthSafety_EId").val(),
            Zone_Id: $("#EZone_Id").val(),
            Community_Id: $("#ECommunity_Id").val(),
            Building_Id: $("#EBuilding_Id").val(),
            Zone_Manager: $("#EZone_Manager").val(),
            Zone_Supervisor: $("#EZone_Supervisor").val(),
            Date_of_Inspection: $("#Inspection_Date").val(),
            Description: $("#EDescription").val(),
            Module_Name: $("#EModule_Name").val(),
            Hyper_Link: $("#EHyper_Link").val()
        };
        $.ajax({
            url: "/HandOverInspection/Update_HealthSafety_Building_Pending",
            type: "POST",
            cache: false,
            data: JSON.stringify(Obj),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data == "200") {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: 'Updated Successfully',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(function () {
                        window.location.reload();
                    });
                }
                else {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'Error',
                        title: 'Error',
                        showConfirmButton: false,
                        timer: 1500
                    });
                }
            },
        });
    });
</script>
<script>
    var Zone_Id = $("#EZone_Id").val();
    var ECommunity_Id = $("#ECommunity_Id").val();
    MANAGER_EMP_DRP_DWN('Zone_Manager', Zone_Id, ECommunity_Id);
    SUPERVISOR_EMP_DRP_DWN('Supervisor', Zone_Id, ECommunity_Id);
    function MANAGER_EMP_DRP_DWN(Role_Name, Zone_Id, Community_Id) {
        $.post("@Url.Action("LoadEmpbyRole", "CommonMaster")", { Role_Name: Role_Name, Zone_Id: Zone_Id, Community_Id: Community_Id }, function (data) {
            $("#EZone_Manager").empty();
            $("#EZone_Manager").append("<option value='' style='text-align:center'>--Select--</option>");
            $(data).each(function (i, e) {
                $("#EZone_Manager").append("<option value=" + e.Employee_Identity_Id + ">" + e.First_Name + "</option>");
                //$("#EZone_Manager").append("<option value=" + e.Employee_Identity_Id + ">" + e.First_Name + " / " + e.Email_Id + "</option>");
            });
        });
    }
    function SUPERVISOR_EMP_DRP_DWN(Role_Name, Zone_Id, Community_Id) {
        $.post("@Url.Action("LoadEmpbyRole", "CommonMaster")", { Role_Name: Role_Name, Zone_Id: Zone_Id, Community_Id: Community_Id }, function (data) {
            $("#EZone_Supervisor").empty();
            $("#EZone_Supervisor").append("<option value='' style='text-align:center'>--Select--</option>");
            $(data).each(function (i, e) {
                $("#EZone_Supervisor").append("<option value=" + e.Employee_Identity_Id + ">" + e.First_Name + "</option>");
            });
        });
    }
    ApplySelect2("#EZone_Supervisor");
    ApplySelect2("#EZone_Manager");

    function ApplySelect2(id) {
        $(id).select2({
            placeholder: "--Select--",
            theme: 'bootstrap-5',
        });
    }
</script>