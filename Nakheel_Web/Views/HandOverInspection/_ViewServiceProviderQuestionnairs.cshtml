@using Microsoft.AspNetCore.Http;
@using Nakheel_Web.Models.AccountsMaster;
@using Newtonsoft.Json;
@using static Nakheel_Web.Authentication.Common;
@inject IHttpContextAccessor HttpContextAccessor;
@{
    var str = HttpContextAccessor.HttpContext!.Session.GetString("Login");
    string Des = Decrypt(str!);
    Login_ LoginClass = JsonConvert.DeserializeObject<Login_>(Des!)!;
}
@model Nakheel_Web.Models.HandOverInsMaster.M_Insp_ServiceProvider_Model;
@if (Model != null)
{
    <div class="row">
        <div class="col-12">
            <!-- Contact Detail -->
            <div class="col-xxl-12 mb-5 mb-xxl-0">
                <div class="table-responsive" style="height:500px; overflow-y: scroll;">
                    <br />
                    <table id="tblInspServiceProviderQns" class="table table-sm table-striped dt-responsive nowrap tblround" style="width:130%">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th style="width:15%;">Questionnaire</th>
                                <th>Action</th>
                                <th>Photo</th>
                                <th>Hazard & Risk</th>
                                <th>Requirements</th>
                                <th>Description of Action/Observation</th>
                                <th>Category</th>
                                <th>Sub Category</th>
                                <th>Risk Level</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyServiceProvideQns">
                            @if (Model != null)
                            {
                                var subSno = 1;
                                foreach (var Question in Model.L_Insp_ServiceProvider_Qns!)
                                {
                                    @*<tr>Authority Approval / Legal Compliance</tr>*@
                                    <tr>
                                        <td style="display:none;"><input type="hidden" value="@Question.Insp_Topic_Id" class="Insp_Topic_Id" /></td>
                                        <td style="display:none;"><input type="hidden" value="@Question.Insp_Questionnaires_Id" class="Insp_Question_Id" /></td>
                                        <td><b>@subSno</b></td>
                                        <td>
                                            <b disabled class="Questionaire_Id" asp-for="@Question.Insp_Questionnaires_Name">@Question.Insp_Questionnaires_Name </b>
                                        </td>
                                        <td>
                                            <input type="radio" name="Action_@subSno" id="Action_Qns_@subSno" class="Qns_Action" value="Yes" style="vertical-align: middle;" onclick="Fn_ActionCheck('@subSno','Yes')" />&nbsp;Yes<br />
                                            <input type="radio" name="Action_@subSno" id="Action_Qns_@subSno" class="Qns_Action" value="No" style="vertical-align: middle;" onclick="Fn_ActionCheck('@subSno','No')" />&nbsp;No<br />
                                            <input type="radio" name="Action_@subSno" id="Action_Qns_@subSno" class="Qns_Action" value="NA" style="vertical-align: middle;" onclick="Fn_ActionCheck('@subSno','NA')" checked />&nbsp;NA
                                        </td>
                                        <td>
                                            <input id="Qnfile_@subSno" class="form-control file InputPhoto" onchange="uploadFiles('Qnfile_@subSno','QnPhoto_@subSno')" type="file" accept=".png, .jpg, .jpeg">
                                            <input type="hidden" value="" class="QnPhoto" name="QnPhoto" id="QnPhoto_@subSno">
                                        </td>

                                        <td>
                                            <textarea type="file" name="Hazard_Risk" id="Hazard_Risk_@subSno" class="form-control Hazard_Risk" style="overflow-y:scroll;"></textarea>
                                        </td>
                                        <td>
                                            <textarea type="file" name="Requirements" id="Requirements_@subSno" class="form-control Requirements" style="overflow-y:scroll;"></textarea>
                                        </td>
                                        <td>
                                            <textarea type="file" name="QnDescription" id="QnDescription_@subSno" class="form-control QnDescription" style="overflow-y:scroll;"></textarea>
                                        </td>
                                        <td>
                                            <select onchange="SubCategoryList(this.value, @subSno)" class="form-control Insp_Category" id="Insp_Category_@subSno" name="Insp_Category" style='text-align:center;'>
                                                <option value="0" style="text-align:center;" disabled selected="selected">--Select--</option>
                                                <option value="1">Health & Safety</option>
                                                <option value="2">Fire & Life Safety</option>
                                                <option value="3">Environmental</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="form-select Sub_Category" name="Sub_Category" id="Sub_Category_@subSno" style="width:250px;" required>
                                                <option value="" style="text-align:center;" disabled selected="selected">--Select--</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="form-control Insp_Risk" id="Insp_Risk_@subSno" name="Insp_Risk" style='text-align:center;'>
                                                <option value="0">--Select--</option>
                                                <option value="Low">Low</option>
                                                <option value="Medium">Medium</option>
                                                <option value="High">High</option>
                                            </select>
                                        </td>
                                    </tr>
                                    subSno++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Other Observations -->
    <div class="row">
        <div class="col-lg-12">
            <div class="row">
                <div class="col-lg-12">
                    <div class="col-lg-9">
                        <h4 class="d-flex align-items-center mb-3">Other Observations</h4>
                    </div>
                    <div class="mb-6">
                        <button type="button" style="background-color: #032639;color:white;float: right;height: 33px;margin-top: -34px;" class="btn" value="Add" onclick="Fn_Add_More_Finding()">+Add More</button>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table id="tbl_Temp_Insp_Obser" class="table tblround table-sm table-striped" style="width:200%">
                    <thead>
                        <tr>
                            <th>Observations</th>
                            <th>Hazard & Risk</th>
                            <th>Requirements</th>
                            <th>Description of Action Required</th>
                            <th>Category</th>
                            <th>Observation Type</th>
                            <th>Risk Level</th>
                            <th>Evidence</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input class="form-control Insp_HSObs_Id" value="0" type="hidden" id="Insp_HSObs_Id">
                                <textarea id="HS_Observations" name="HS_Observations" class="form-control HS_Observations" placeholder="Enter Observations" rows="1"></textarea>
                            </td>
                            <td>
                                <textarea id="HS_HazardRisk" name="HS_HazardRisk" class="form-control HS_HazardRisk" placeholder="Enter Hazard & Risk" rows="1"></textarea>
                            </td>
                            <td>
                                <textarea id="HS_Requirements" name="HS_Requirements" class="form-control HS_Requirements" placeholder="Enter Requirements" rows="1"></textarea>
                            </td>
                            <td>
                                <textarea id="HS_ActionRequired" name="HS_ActionRequired" class="form-control HS_ActionRequired" placeholder="Enter Action Required" rows="1"></textarea>
                            </td>
                            <td style="width: 150px;">
                                <select onchange="SuCat(this.value)" class="form-select HS_Category" id="HS_Category" >
                                    <option value="" style="text-align:center;" disabled selected="selected">--Select--</option>
                                </select>
                            </td>
                            <td style="width:250px;">
                                <select class="form-select HS_SubCategory" name="HS_SubCategory" id="HS_SubCategory" >
                                    <option value="" style="text-align:center;" disabled selected="selected">--Select--</option>
                                </select>
                            </td>
                            <td>
                                <select class="form-select HS_RiskLevel" name="HS_RiskLevel" id="HS_RiskLevel">
                                    <option value="" disabled selected="selected">--Select--</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </td>
                            <td style="width: 180px;">
                                <input id="file10" class="form-control file InputPhoto" onchange="uploadFiles('file10','UploadPhotos10')" type="file" accept=".png, .jpg, .jpeg" multiple>
                                <input type="hidden" value="" class="UploadPhotos" name="UploadPhotos0" id="UploadPhotos10">
                            </td>
                            <td>
                                <label>
                                    <i class="mdi mdi-delete TblDeleteButton font-size-18" style="color:red;">
                                    </i>
                                </label>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    @if (Model!.Status == "15" || Model!.Status == "3")
    {
        @if (LoginClass.Role_Id == "15" || LoginClass.Role_Id == "16" || LoginClass.Role_Id == "17")
        {
            <div>
                <br />
                <div class="row">
                    <div class="mb-6">
                        <label for="example-text-input" class="col-md-8 col-form-label">
                            Raise the Safety Violation Notice ?<span class="requ">*</span>
                            <label for="Safety_Violation_Yes" onclick="FnSafetyViolation_YesCS('1')"> <input id="Safety_Violation_Yes" class="Safety_Violation" name="Safety_Violation" type="radio" value="Yes" checked>&nbsp;Yes</label>&nbsp;&nbsp;
                            <label for="Safety_Violation_No" onclick="FnSafetyViolation_YesCS('2')"> <input id="Safety_Violation_No" class="Safety_Violation" name="Safety_Violation" type="radio" value="No">&nbsp;No</label>
                        </label>
                    </div>
                    <div class="mb-6" id="Safety_DescriptionCS" style=" display:none;">
                        <label for="example-number-input" class="col-md-4 col-form-label">Remarks</label>
                        <textarea class="form-control mb-6" id="SVCS_Description" name="SV_Description"></textarea>
                        <br />
                    </div>
                    <div class="col-lg-6">
                        <button type="button" class="btn btn-success waves-effect waves-light submit_SpBuildingQns" style="float: right;cursor:pointer">
                            <i class="bx bx-check-double font-size-16 align-middle me-2"></i> Submit
                        </button>
                    </div>
                    <div class="col-lg-6">
                        <button type="reset" class="btn btn-danger waves-effect waves-light" style="cursor:pointer;">
                            <i class="bx bx-block font-size-16 align-middle me-2"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        }
    }
}
<script>
    $(".submit_SpBuildingQns").click(function () {
        debugger;
        var QNS_ARR = [];
        var subSno = 1;
        $('#tblInspServiceProviderQns tbody > tr').each(function () {
            debugger
            var varInsp_Question_Id = $(this).closest('tr').find('.Insp_Question_Id').val();
            var varQns_Action = $(this).closest('tr').find('input[name="Action_' + subSno + '"]:checked').val();
            var varPhoto_File_Path = $(this).closest('tr').find('.QnPhoto').val();
            var varHazard_Risk = $(this).closest('tr').find('.Hazard_Risk').val();
            var varRequirements = $(this).closest('tr').find('.Requirements').val();
            var varAction_Description = $(this).closest('tr').find('.QnDescription').val();
            var varCategory = $(this).closest('tr').find('.Insp_Category').val();
            var varRisk_Level = $(this).closest('tr').find('.Insp_Risk').val();
            if (varPhoto_File_Path != "" && varPhoto_File_Path != null) {
                //Photo_List_QN = [];
                var val_UploadPhotos = varPhoto_File_Path.split(',');
                var varPhoto_File_Path_QnFinal;
                var i;
                for (i = 0; i < val_UploadPhotos.length; i++) {
                    var x = val_UploadPhotos[i].replace(/[\(\)\[\]{}'"]/g, "");
                    if (x != "/") {
                        //var Pdata = {};
                        varPhoto_File_Path_QnFinal = x;
                        //Pdata.Insp_Sub_Photo_Id = "0";
                        //Photo_List_QN.push(Pdata);
                    }
                }
            }
            var data = {};
            data.Insp_Questionnaires_Id = varInsp_Question_Id;
            data.Qns_Action = varQns_Action;
            data.Photo_File_Path = varPhoto_File_Path_QnFinal;
            data.Hazard_Risk = varHazard_Risk;
            data.Requirements = varRequirements;
            data.Description_Action = varAction_Description;
            data.Category = varCategory;
            data.Risk_Level = varRisk_Level;
            QNS_ARR.push(data);
            subSno++;
        });
        debugger
        var val = $("#Insp_Service_Provider_BId").val();
        var SV = $('input[name="Safety_Violation"]:checked').val();
        var Obj = {
            Insp_Service_Provider_Id: $("#Insp_Service_Provider_BId").val(),
            Safety_Violation: $('input[name="Safety_Violation"]:checked').val(),
            L_Insp_Service_Provider_Qns: QNS_ARR
        };
        $.ajax({
            url: "/HandOverInspection/Insp_ServiceProvider_Qn_Add",
            type: "POST",
            cache: false,
            data: JSON.stringify(Obj),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data == "200") {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: 'Updated Successfully',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(function () {
                        window.location.reload();
                    });
                }
                else {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'Error',
                        title: 'Error',
                        showConfirmButton: false,
                        timer: 1500
                    });
                }
            },
        });
    });
</script>
<script>
    var Qns_Action_Check = $(".Qns_Action").val();
    if (Qns_Action_Check == "Yes" || Qns_Action_Check == "NA") {
        $(".Hazard_Risk").attr('disabled', 'disabled');
        $(".Requirements").attr('disabled', 'disabled');
        //$(".QnDescription").attr('disabled', 'disabled');
        $(".Insp_Category").attr('disabled', 'disabled');
        $(".Sub_Category").attr('disabled', 'disabled');
        $(".Insp_Risk").attr('disabled', 'disabled');
    }
    function Fn_ActionCheck(rowval, status) {
        if (status == "Yes" || status == "NA") {
            $("#Hazard_Risk_" + rowval).val('');
            $("#Requirements_" + rowval).val('');
            $("#QnDescription_" + rowval).val('');
            $("#Insp_Category_" + rowval).prop('selectedIndex', 0);
            $("#Sub_Category_" + rowval).prop('selectedIndex', 0);
            $("#Insp_Risk_" + rowval).prop('selectedIndex', 0);
            $("#Hazard_Risk_" + rowval).attr('disabled', 'disabled');
            $("#Requirements_" + rowval).attr('disabled', 'disabled');
            //$("#QnDescription_" + rowval).attr('disabled', 'disabled');
            $("#Insp_Category_" + rowval).attr('disabled', 'disabled');
            $("#Sub_Category_" + rowval).attr('disabled', 'disabled');
            $("#Insp_Risk_" + rowval).attr('disabled', 'disabled');
        }
        else {
            $("#Hazard_Risk_" + rowval).removeAttr('disabled');
            $("#Requirements_" + rowval).removeAttr('disabled');
            $("#QnDescription_" + rowval).removeAttr('disabled');
            $("#Insp_Category_" + rowval).removeAttr('disabled');
            $("#Sub_Category_" + rowval).removeAttr('disabled');
            $("#Insp_Risk_" + rowval).removeAttr('disabled');
        }
    }
    function SubCategoryList(Value, rowval) {
        $.post("@Url.Action("Insp_Sub_Category_Master_GetbyId", "Inspection")", { Value: Value }, function (data) {
            $("#Sub_Category_" + rowval).empty();
            $(data).each(function (i, e) {
                $("#Sub_Category_" + rowval).append("<option value=" + e.Value + ">" + e.Text + "</option>");
            });
        });
    }
</script>
<script>
    function uploadFiles(inputId, UploadPhotoId) {
        debugger;
        var input = document.getElementById(inputId);
        var files = input.files;
        var formData = new FormData();
        if (files.length <= 5) {
            for (var i = 0; i != files.length; i++) {
                formData.append("files", files[i]);
            }
            var _url = '@Url.Action("UploadImage", "HandOverInspection")';
            $.ajax({
                url: _url,
                data: formData,
                processData: false,
                contentType: false,
                type: "POST",
                success: function (data) {
                    $("#" + UploadPhotoId).val("");
                    $("#" + UploadPhotoId).val(data);
                }
            });
        }
        else {
            $("#" + inputId).val("");
            $("#" + UploadPhotoId).val("");
            toastr["info"]("Maximum Allowed 5 Files");
        }
    }
    function uploadFilesAddMore(inputId, UploadPhotoId) {
        debugger;
        var test = inputId.id;
        var test1 = UploadPhotoId.id;
        inputId = test;
        UploadPhotoId = test1;
        var input = document.getElementById(inputId);
        var files = input.files;
        var formData = new FormData();
        if (files.length <= 5) {
            for (var i = 0; i != files.length; i++) {
                formData.append("files", files[i]);
            }
            var _url = '@Url.Action("UploadImage", "HandOverInspection")';
            $.ajax({
                url: _url,
                data: formData,
                processData: false,
                contentType: false,
                type: "POST",
                success: function (data) {
                    $("#" + UploadPhotoId).val("");
                    $("#" + UploadPhotoId).val(data);
                }
            });
        }
        else {
            $("#" + inputId).val("");
            $("#" + UploadPhotoId).val("");
            toastr["info"]("Maximum Allowed 5 Files");
        }
    }
</script>